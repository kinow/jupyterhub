

<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <title>External services &#8212; JupyterHub 1.2.0dev documentation</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" integrity="sha384-KA6wR/X5RY4zFAHpv/CnoG2UW1uogYfdnP67Uv7eULvTveboZJg0qUpmJZb5VqzN" crossorigin="anonymous">
    <link href="../_static/css/index.css" rel="stylesheet">
    <link rel="stylesheet" href="../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Frequently asked questions" href="faq.html" />
    <link rel="prev" title="Spawners and single-user notebook servers" href="spawners-basics.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="docsearch:language" content="en">
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main">
<div class="container-xl">

    
    <a class="navbar-brand" href="../index.html">
      <img src="../_static/logo.png" class="logo" alt="logo">
    </a>
    
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-menu" aria-controls="navbar-menu" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar-menu" class="col-lg-9 collapse navbar-collapse">
      <ul id="navbar-main-elements" class="navbar-nav mr-auto">
        
        
        <li class="nav-item ">
            <a class="nav-link" href="../installation-guide.html">Installation</a>
        </li>
        
        <li class="nav-item active">
            <a class="nav-link" href="index.html">Get Started</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../reference/index.html">Technical Reference</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../index-admin.html">Administrator’s Guide</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../api/index.html">JupyterHub API</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../contributing/index.html">Contributing</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../index-about.html">About</a>
        </li>
        
        
      </ul>


      

      <ul class="navbar-nav">
        
        
      </ul>
    </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
          <div class="col-12 col-md-3 bd-sidebar">

<form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form>


<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">

  <div class="bd-toc-item active">
  

  <ul class="nav bd-sidenav">
      
      
      
      
        
          
              <li class="">
                  <a href="config-basics.html">Configuration Basics</a>
              </li>
          
        
          
              <li class="">
                  <a href="networking-basics.html">Networking basics</a>
              </li>
          
        
          
              <li class="">
                  <a href="security-basics.html">Security settings</a>
              </li>
          
        
          
              <li class="">
                  <a href="authenticators-users-basics.html">Authentication and User Basics</a>
              </li>
          
        
          
              <li class="">
                  <a href="spawners-basics.html">Spawners and single-user notebook servers</a>
              </li>
          
        
          
              <li class="active">
                  <a href="">External services</a>
              </li>
          
        
          
              <li class="">
                  <a href="faq.html">Frequently asked questions</a>
              </li>
          
        
          
              <li class="">
                  <a href="institutional-faq.html">Institutional FAQ</a>
              </li>
          
        
      
      
      
      
      
      
      
      
      
      
      
      
    </ul>

</nav>
          </div>
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
              
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="nav section-nav flex-column">
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#real-world-example-to-cull-idle-servers" class="nav-link">Real-world example to cull idle servers</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#api-token-basics" class="nav-link">API Token basics</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#create-an-api-token" class="nav-link">Create an API token</a>
        </li>
    
        <li class="nav-item toc-entry toc-h3">
            <a href="#pass-environment-variable-with-token-to-the-hub" class="nav-link">Pass environment variable with token to the Hub</a>
        </li>
    
        <li class="nav-item toc-entry toc-h3">
            <a href="#use-api-tokens-for-services-and-tasks-that-require-external-access" class="nav-link">Use API tokens for services and tasks that require external access</a>
        </li>
    
        <li class="nav-item toc-entry toc-h3">
            <a href="#restart-jupyterhub" class="nav-link">Restart JupyterHub</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#authenticating-to-single-user-servers-using-api-token" class="nav-link">Authenticating to single-user servers using API token</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#configure-cull-idle-to-run-as-a-hub-managed-service" class="nav-link">Configure cull-idle to run as a Hub-Managed Service</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#run-cull-idle-manually-as-a-standalone-script" class="nav-link">Run cull-idle manually as a standalone script</a>
        </li>
    
    </ul>
</nav>


              
          </div>
          

          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <div class="section" id="external-services">
<h1>External services<a class="headerlink" href="#external-services" title="Permalink to this headline">¶</a></h1>
<p>When working with JupyterHub, a <strong>Service</strong> is defined as a process
that interacts with the Hub’s REST API. A Service may perform a specific
or action or task. For example, shutting down individuals’ single user
notebook servers that have been idle for some time is a good example of
a task that could be automated by a Service. Let’s look at how the
<a class="reference external" href="https://github.com/jupyterhub/jupyterhub/blob/master/examples/cull-idle/cull_idle_servers.py">cull_idle_servers</a> script can be used as a Service.</p>
<div class="section" id="real-world-example-to-cull-idle-servers">
<h2>Real-world example to cull idle servers<a class="headerlink" href="#real-world-example-to-cull-idle-servers" title="Permalink to this headline">¶</a></h2>
<p>JupyterHub has a REST API that can be used by external services. This
document will:</p>
<ul class="simple">
<li><p>explain some basic information about API tokens</p></li>
<li><p>clarify that API tokens can be used to authenticate to
single-user servers as of <a class="reference internal" href="../changelog.html"><span class="doc">version 0.8.0</span></a></p></li>
<li><p>show how the <a class="reference external" href="https://github.com/jupyterhub/jupyterhub/blob/master/examples/cull-idle/cull_idle_servers.py">cull_idle_servers</a> script can be:</p>
<ul>
<li><p>used in a Hub-managed service</p></li>
<li><p>run as a standalone script</p></li>
</ul>
</li>
</ul>
<p>Both examples for <code class="docutils literal notranslate"><span class="pre">cull_idle_servers</span></code> will communicate tasks to the
Hub via the REST API.</p>
</div>
<div class="section" id="api-token-basics">
<h2>API Token basics<a class="headerlink" href="#api-token-basics" title="Permalink to this headline">¶</a></h2>
<div class="section" id="create-an-api-token">
<h3>Create an API token<a class="headerlink" href="#create-an-api-token" title="Permalink to this headline">¶</a></h3>
<p>To run such an external service, an API token must be created and
provided to the service.</p>
<p>As of <a class="reference internal" href="../changelog.html"><span class="doc">version 0.6.0</span></a>, the preferred way of doing
this is to first generate an API token:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>openssl rand -hex <span class="m">32</span>
</pre></div>
</div>
<p>In <a class="reference internal" href="../changelog.html"><span class="doc">version 0.8.0</span></a>, a TOKEN request page for
generating an API token is available from the JupyterHub user interface:</p>
<p><img alt="Request API TOKEN page" src="../_images/token-request.png" /></p>
<p><img alt="API TOKEN success page" src="../_images/token-request-success.png" /></p>
</div>
<div class="section" id="pass-environment-variable-with-token-to-the-hub">
<h3>Pass environment variable with token to the Hub<a class="headerlink" href="#pass-environment-variable-with-token-to-the-hub" title="Permalink to this headline">¶</a></h3>
<p>In the case of <code class="docutils literal notranslate"><span class="pre">cull_idle_servers</span></code>, it is passed as the environment
variable called <code class="docutils literal notranslate"><span class="pre">JUPYTERHUB_API_TOKEN</span></code>.</p>
</div>
<div class="section" id="use-api-tokens-for-services-and-tasks-that-require-external-access">
<h3>Use API tokens for services and tasks that require external access<a class="headerlink" href="#use-api-tokens-for-services-and-tasks-that-require-external-access" title="Permalink to this headline">¶</a></h3>
<p>While API tokens are often associated with a specific user, API tokens
can be used by services that require external access for activities
that may not correspond to a specific human, e.g. adding users during
setup for a tutorial or workshop. Add a service and its API token to the
JupyterHub configuration file, <code class="docutils literal notranslate"><span class="pre">jupyterhub_config.py</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">c</span><span class="o">.</span><span class="n">JupyterHub</span><span class="o">.</span><span class="n">services</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;adding-users&#39;</span><span class="p">,</span> <span class="s1">&#39;api_token&#39;</span><span class="p">:</span> <span class="s1">&#39;super-secret-token&#39;</span><span class="p">},</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="restart-jupyterhub">
<h3>Restart JupyterHub<a class="headerlink" href="#restart-jupyterhub" title="Permalink to this headline">¶</a></h3>
<p>Upon restarting JupyterHub, you should see a message like below in the
logs:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Adding</span> <span class="n">API</span> <span class="n">token</span> <span class="k">for</span> <span class="o">&lt;</span><span class="n">username</span><span class="o">&gt;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="authenticating-to-single-user-servers-using-api-token">
<h2>Authenticating to single-user servers using API token<a class="headerlink" href="#authenticating-to-single-user-servers-using-api-token" title="Permalink to this headline">¶</a></h2>
<p>In JupyterHub 0.7, there is no mechanism for token authentication to
single-user servers, and only cookies can be used for authentication.
0.8 supports using JupyterHub API tokens to authenticate to single-user
servers.</p>
</div>
<div class="section" id="configure-cull-idle-to-run-as-a-hub-managed-service">
<h2>Configure <code class="docutils literal notranslate"><span class="pre">cull-idle</span></code> to run as a Hub-Managed Service<a class="headerlink" href="#configure-cull-idle-to-run-as-a-hub-managed-service" title="Permalink to this headline">¶</a></h2>
<p>In <code class="docutils literal notranslate"><span class="pre">jupyterhub_config.py</span></code>, add the following dictionary for the
<code class="docutils literal notranslate"><span class="pre">cull-idle</span></code> Service to the <code class="docutils literal notranslate"><span class="pre">c.JupyterHub.services</span></code> list:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">c</span><span class="o">.</span><span class="n">JupyterHub</span><span class="o">.</span><span class="n">services</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;cull-idle&#39;</span><span class="p">,</span>
        <span class="s1">&#39;admin&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;command&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s1">&#39;cull_idle_servers.py&#39;</span><span class="p">,</span> <span class="s1">&#39;--timeout=3600&#39;</span><span class="p">],</span>
    <span class="p">}</span>
<span class="p">]</span>
</pre></div>
</div>
<p>where:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">'admin':</span> <span class="pre">True</span></code> indicates that the Service has ‘admin’ permissions, and</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">'command'</span></code> indicates that the Service will be launched as a
subprocess, managed by the Hub.</p></li>
</ul>
</div>
<div class="section" id="run-cull-idle-manually-as-a-standalone-script">
<h2>Run <code class="docutils literal notranslate"><span class="pre">cull-idle</span></code> manually as a standalone script<a class="headerlink" href="#run-cull-idle-manually-as-a-standalone-script" title="Permalink to this headline">¶</a></h2>
<p>Now you can run your script, i.e. <code class="docutils literal notranslate"><span class="pre">cull_idle_servers</span></code>, by providing it
the API token and it will authenticate through the REST API to
interact with it.</p>
<p>This will run <code class="docutils literal notranslate"><span class="pre">cull-idle</span></code> manually. <code class="docutils literal notranslate"><span class="pre">cull-idle</span></code> can be run as a standalone
script anywhere with access to the Hub, and will periodically check for idle
servers and shut them down via the Hub’s REST API. In order to shutdown the
servers, the token given to cull-idle must have admin privileges.</p>
<p>Generate an API token and store it in the <code class="docutils literal notranslate"><span class="pre">JUPYTERHUB_API_TOKEN</span></code> environment
variable. Run <code class="docutils literal notranslate"><span class="pre">cull_idle_servers.py</span></code> manually.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>    <span class="nb">export</span> <span class="nv">JUPYTERHUB_API_TOKEN</span><span class="o">=</span><span class="s1">&#39;token&#39;</span>
    python3 cull_idle_servers.py <span class="o">[</span>--timeout<span class="o">=</span><span class="m">900</span><span class="o">]</span> <span class="o">[</span>--url<span class="o">=</span>http://127.0.0.1:8081/hub/api<span class="o">]</span>
</pre></div>
</div>
</div>
</div>


              </div>
              
              
              <div class='prev-next-bottom'>
                
    <a class='left-prev' id="prev-link" href="spawners-basics.html" title="previous page">Spawners and single-user notebook servers</a>
    <a class='right-next' id="next-link" href="faq.html" title="next page">Frequently asked questions</a>

              </div>
              
          </main>
          

      </div>
    </div>

    <script src="../_static/js/index.js"></script>
    <footer class="footer mt-5 mt-md-0">
  <div class="container">
    <p>
          &copy; Copyright 2016, Project Jupyter team.<br/>
        Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.0.4.<br/>
    </p>
  </div>
</footer>
  </body>
</html>