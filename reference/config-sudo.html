

<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <title>Run JupyterHub without root privileges using sudo &#8212; JupyterHub 1.2.0dev documentation</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" integrity="sha384-KA6wR/X5RY4zFAHpv/CnoG2UW1uogYfdnP67Uv7eULvTveboZJg0qUpmJZb5VqzN" crossorigin="anonymous">
    <link href="../_static/css/index.css" rel="stylesheet">
    <link rel="stylesheet" href="../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Configuration Reference" href="config-reference.html" />
    <link rel="prev" title="Using a reverse proxy" href="config-proxy.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="docsearch:language" content="en">
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main">
<div class="container-xl">

    
    <a class="navbar-brand" href="../index.html">
      <img src="../_static/logo.png" class="logo" alt="logo">
    </a>
    
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-menu" aria-controls="navbar-menu" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar-menu" class="col-lg-9 collapse navbar-collapse">
      <ul id="navbar-main-elements" class="navbar-nav mr-auto">
        
        
        <li class="nav-item ">
            <a class="nav-link" href="../installation-guide.html">Installation</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../getting-started/index.html">Get Started</a>
        </li>
        
        <li class="nav-item active">
            <a class="nav-link" href="index.html">Technical Reference</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../index-admin.html">Administrator’s Guide</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../api/index.html">JupyterHub API</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../contributing/index.html">Contributing</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../index-about.html">About</a>
        </li>
        
        
      </ul>


      

      <ul class="navbar-nav">
        
        
      </ul>
    </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
          <div class="col-12 col-md-3 bd-sidebar">

<form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form>


<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">

  <div class="bd-toc-item active">
  

  <ul class="nav bd-sidenav">
      
      
      
      
      
      
        
          
              <li class="">
                  <a href="technical-overview.html">Technical Overview</a>
              </li>
          
        
          
              <li class="">
                  <a href="urls.html">JupyterHub URL scheme</a>
              </li>
          
        
          
              <li class="">
                  <a href="websecurity.html">Security Overview</a>
              </li>
          
        
          
              <li class="">
                  <a href="authenticators.html">Authenticators</a>
              </li>
          
        
          
              <li class="">
                  <a href="spawners.html">Spawners</a>
              </li>
          
        
          
              <li class="">
                  <a href="services.html">Services</a>
              </li>
          
        
          
              <li class="">
                  <a href="proxy.html">Writing a custom Proxy implementation</a>
              </li>
          
        
          
              <li class="">
                  <a href="separate-proxy.html">Running proxy separately from the hub</a>
              </li>
          
        
          
              <li class="">
                  <a href="rest.html">Using JupyterHub’s REST API</a>
              </li>
          
        
          
              <li class="">
                  <a href="database.html">The Hub’s Database</a>
              </li>
          
        
          
              <li class="">
                  <a href="templates.html">Working with templates and UI</a>
              </li>
          
        
          
              <li class="">
                  <a href="../events/index.html">Eventlogging and Telemetry</a>
              </li>
          
        
          
              <li class="">
                  <a href="config-user-env.html">Configuring user environments</a>
              </li>
          
        
          
              <li class="">
                  <a href="config-examples.html">Configuration examples</a>
              </li>
          
        
          
              <li class="">
                  <a href="config-ghoauth.html">Configure GitHub OAuth</a>
              </li>
          
        
          
              <li class="">
                  <a href="config-proxy.html">Using a reverse proxy</a>
              </li>
          
        
          
              <li class="active">
                  <a href="">Run JupyterHub without root privileges using sudo</a>
              </li>
          
        
          
              <li class="">
                  <a href="config-reference.html">Configuration Reference</a>
              </li>
          
        
      
      
      
      
      
      
      
      
      
      
    </ul>

</nav>
          </div>
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
              
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="nav section-nav flex-column">
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#overview" class="nav-link">Overview</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#create-a-user" class="nav-link">Create a user</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#set-up-sudospawner" class="nav-link">Set up sudospawner</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#edit-etc-sudoers" class="nav-link">Edit /etc/sudoers</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#test-sudo-setup" class="nav-link">Test sudo setup</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#enable-pam-for-non-root" class="nav-link">Enable PAM for non-root</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#shadow-group-linux" class="nav-link">Shadow group (Linux)</a>
        </li>
    
        <li class="nav-item toc-entry toc-h3">
            <a href="#shadow-group-freebsd" class="nav-link">Shadow group (FreeBSD)</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#test-that-pam-works" class="nav-link">Test that PAM works</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#make-a-directory-for-jupyterhub" class="nav-link">Make a directory for JupyterHub</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#start-jupyterhub" class="nav-link">Start jupyterhub</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#troubleshooting-selinux" class="nav-link">Troubleshooting: SELinux</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#troubleshooting-pam-session-errors" class="nav-link">Troubleshooting: PAM session errors</a>
        </li>
    
    </ul>
</nav>


              
          </div>
          

          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <div class="section" id="run-jupyterhub-without-root-privileges-using-sudo">
<h1>Run JupyterHub without root privileges using <code class="docutils literal notranslate"><span class="pre">sudo</span></code><a class="headerlink" href="#run-jupyterhub-without-root-privileges-using-sudo" title="Permalink to this headline">¶</a></h1>
<p><strong>Note:</strong> Setting up <code class="docutils literal notranslate"><span class="pre">sudo</span></code> permissions involves many pieces of system
configuration. It is quite easy to get wrong and very difficult to debug.
Only do this if you are very sure you must.</p>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>There are many Authenticators and Spawners available for JupyterHub. Some, such
as DockerSpawner or OAuthenticator, do not need any elevated permissions. This
document describes how to get the full default behavior of JupyterHub while
running notebook servers as real system users on a shared system without
running the Hub itself as root.</p>
<p>Since JupyterHub needs to spawn processes as other users, the simplest way
is to run it as root, spawning user servers with <a class="reference external" href="http://linux.die.net/man/2/setuid">setuid</a>.
But this isn’t especially safe, because you have a process running on the
public web as root.</p>
<p>A <strong>more prudent way</strong> to run the server while preserving functionality is to
create a dedicated user with <code class="docutils literal notranslate"><span class="pre">sudo</span></code> access restricted to launching and
monitoring single-user servers.</p>
</div>
<div class="section" id="create-a-user">
<h2>Create a user<a class="headerlink" href="#create-a-user" title="Permalink to this headline">¶</a></h2>
<p>To do this, first create a user that will run the Hub:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo useradd rhea
</pre></div>
</div>
<p>This user shouldn’t have a login shell or password (possible with -r).</p>
</div>
<div class="section" id="set-up-sudospawner">
<h2>Set up sudospawner<a class="headerlink" href="#set-up-sudospawner" title="Permalink to this headline">¶</a></h2>
<p>Next, you will need <a class="reference external" href="https://github.com/jupyter/sudospawner">sudospawner</a>
to enable monitoring the single-user servers with sudo:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo python3 -m pip install sudospawner
</pre></div>
</div>
<p>Now we have to configure sudo to allow the Hub user (<code class="docutils literal notranslate"><span class="pre">rhea</span></code>) to launch
the sudospawner script on behalf of our hub users (here <code class="docutils literal notranslate"><span class="pre">zoe</span></code> and <code class="docutils literal notranslate"><span class="pre">wash</span></code>).
We want to confine these permissions to only what we really need.</p>
</div>
<div class="section" id="edit-etc-sudoers">
<h2>Edit <code class="docutils literal notranslate"><span class="pre">/etc/sudoers</span></code><a class="headerlink" href="#edit-etc-sudoers" title="Permalink to this headline">¶</a></h2>
<p>To do this we add to <code class="docutils literal notranslate"><span class="pre">/etc/sudoers</span></code> (use <code class="docutils literal notranslate"><span class="pre">visudo</span></code> for safe editing of sudoers):</p>
<ul class="simple">
<li><p>specify the list of users <code class="docutils literal notranslate"><span class="pre">JUPYTER_USERS</span></code> for whom <code class="docutils literal notranslate"><span class="pre">rhea</span></code> can spawn servers</p></li>
<li><p>set the command <code class="docutils literal notranslate"><span class="pre">JUPYTER_CMD</span></code> that <code class="docutils literal notranslate"><span class="pre">rhea</span></code> can execute on behalf of users</p></li>
<li><p>give <code class="docutils literal notranslate"><span class="pre">rhea</span></code> permission to run <code class="docutils literal notranslate"><span class="pre">JUPYTER_CMD</span></code> on behalf of <code class="docutils literal notranslate"><span class="pre">JUPYTER_USERS</span></code>
without entering a password</p></li>
</ul>
<p>For example:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># comma-separated whitelist of users that can spawn single-user servers</span>
<span class="c1"># this should include all of your Hub users</span>
Runas_Alias <span class="nv">JUPYTER_USERS</span> <span class="o">=</span> rhea, zoe, wash

<span class="c1"># the command(s) the Hub can run on behalf of the above users without needing a password</span>
<span class="c1"># the exact path may differ, depending on how sudospawner was installed</span>
Cmnd_Alias <span class="nv">JUPYTER_CMD</span> <span class="o">=</span> /usr/local/bin/sudospawner

<span class="c1"># actually give the Hub user permission to run the above command on behalf</span>
<span class="c1"># of the above users without prompting for a password</span>
rhea <span class="nv">ALL</span><span class="o">=(</span>JUPYTER_USERS<span class="o">)</span> NOPASSWD:JUPYTER_CMD
</pre></div>
</div>
<p>It might be useful to modify <code class="docutils literal notranslate"><span class="pre">secure_path</span></code> to add commands in path.</p>
<p>As an alternative to adding every user to the <code class="docutils literal notranslate"><span class="pre">/etc/sudoers</span></code> file, you can
use a group in the last line above, instead of <code class="docutils literal notranslate"><span class="pre">JUPYTER_USERS</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>rhea <span class="nv">ALL</span><span class="o">=(</span>%jupyterhub<span class="o">)</span> NOPASSWD:JUPYTER_CMD
</pre></div>
</div>
<p>If the <code class="docutils literal notranslate"><span class="pre">jupyterhub</span></code> group exists, there will be no need to edit <code class="docutils literal notranslate"><span class="pre">/etc/sudoers</span></code>
again. A new user will gain access to the application when added to the group:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ adduser -G jupyterhub newuser
</pre></div>
</div>
</div>
<div class="section" id="test-sudo-setup">
<h2>Test <code class="docutils literal notranslate"><span class="pre">sudo</span></code> setup<a class="headerlink" href="#test-sudo-setup" title="Permalink to this headline">¶</a></h2>
<p>Test that the new user doesn’t need to enter a password to run the sudospawner
command.</p>
<p>This should prompt for your password to switch to rhea, but <em>not</em> prompt for
any password for the second switch. It should show some help output about
logging options:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ sudo -u rhea sudo -n -u <span class="nv">$USER</span> /usr/local/bin/sudospawner --help
Usage: /usr/local/bin/sudospawner <span class="o">[</span>OPTIONS<span class="o">]</span>
    
Options:
    
--help          show this <span class="nb">help</span> information
...
</pre></div>
</div>
<p>And this should fail:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ sudo -u rhea sudo -n -u <span class="nv">$USER</span> <span class="nb">echo</span> <span class="s1">&#39;fail&#39;</span>
sudo: a password is required
</pre></div>
</div>
</div>
<div class="section" id="enable-pam-for-non-root">
<h2>Enable PAM for non-root<a class="headerlink" href="#enable-pam-for-non-root" title="Permalink to this headline">¶</a></h2>
<p>By default, <a class="reference external" href="http://en.wikipedia.org/wiki/Pluggable_authentication_module">PAM authentication</a>
is used by JupyterHub. To use PAM, the process may need to be able to read
the shadow password database.</p>
<div class="section" id="shadow-group-linux">
<h3>Shadow group (Linux)<a class="headerlink" href="#shadow-group-linux" title="Permalink to this headline">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ ls -l /etc/shadow
-rw-r-----  <span class="m">1</span> root shadow   <span class="m">2197</span> Jul <span class="m">21</span> <span class="m">13</span>:41 shadow
</pre></div>
</div>
<p>If there’s already a shadow group, you are set. If its permissions are more like:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>    $ ls -l /etc/shadow
    -rw-------  <span class="m">1</span> root wheel   <span class="m">2197</span> Jul <span class="m">21</span> <span class="m">13</span>:41 shadow
</pre></div>
</div>
<p>Then you may want to add a shadow group, and make the shadow file group-readable:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ sudo groupadd shadow
$ sudo chgrp shadow /etc/shadow
$ sudo chmod g+r /etc/shadow
</pre></div>
</div>
<p>We want our new user to be able to read the shadow passwords, so add it to the shadow group:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>    $ sudo usermod -a -G shadow rhea
</pre></div>
</div>
<p>If you want jupyterhub to serve pages on a restricted port (such as port 80 for http),
then you will need to give <code class="docutils literal notranslate"><span class="pre">node</span></code> permission to do so:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo setcap <span class="s1">&#39;cap_net_bind_service=+ep&#39;</span> /usr/bin/node
</pre></div>
</div>
<p>However, you may want to further understand the consequences of this.</p>
<p>You may also be interested in limiting the amount of CPU any process can use
on your server. <code class="docutils literal notranslate"><span class="pre">cpulimit</span></code> is a useful tool that is available for many Linux
distributions’ packaging system. This can be used to keep any user’s process
from using too much CPU cycles. You can configure it accoring to <a class="reference external" href="http://ubuntuforums.org/showthread.php?t=992706">these
instructions</a>.</p>
</div>
<div class="section" id="shadow-group-freebsd">
<h3>Shadow group (FreeBSD)<a class="headerlink" href="#shadow-group-freebsd" title="Permalink to this headline">¶</a></h3>
<p><strong>NOTE:</strong> This has not been tested and may not work as expected.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ ls -l /etc/spwd.db /etc/master.passwd
-rw-------  <span class="m">1</span> root  wheel   <span class="m">2516</span> Aug <span class="m">22</span> <span class="m">13</span>:35 /etc/master.passwd
-rw-------  <span class="m">1</span> root  wheel  <span class="m">40960</span> Aug <span class="m">22</span> <span class="m">13</span>:35 /etc/spwd.db
</pre></div>
</div>
<p>Add a shadow group if there isn’t one, and make the shadow file group-readable:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ sudo pw group add shadow
$ sudo chgrp shadow /etc/spwd.db
$ sudo chmod g+r /etc/spwd.db
$ sudo chgrp shadow /etc/master.passwd
$ sudo chmod g+r /etc/master.passwd
</pre></div>
</div>
<p>We want our new user to be able to read the shadow passwords, so add it to the
shadow group:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ sudo pw user mod rhea -G shadow
</pre></div>
</div>
</div>
</div>
<div class="section" id="test-that-pam-works">
<h2>Test that PAM works<a class="headerlink" href="#test-that-pam-works" title="Permalink to this headline">¶</a></h2>
<p>We can verify that PAM is working, with:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ sudo -u rhea python3 -c <span class="s2">&quot;import pamela, getpass; print(pamela.authenticate(&#39;</span><span class="nv">$USER</span><span class="s2">&#39;, getpass.getpass()))&quot;</span>
Password: <span class="o">[</span>enter your unix password<span class="o">]</span>
</pre></div>
</div>
</div>
<div class="section" id="make-a-directory-for-jupyterhub">
<h2>Make a directory for JupyterHub<a class="headerlink" href="#make-a-directory-for-jupyterhub" title="Permalink to this headline">¶</a></h2>
<p>JupyterHub stores its state in a database, so it needs write access to a directory.
The simplest way to deal with this is to make a directory owned by your Hub user,
and use that as the CWD when launching the server.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ sudo mkdir /etc/jupyterhub
$ sudo chown rhea /etc/jupyterhub
</pre></div>
</div>
</div>
<div class="section" id="start-jupyterhub">
<h2>Start jupyterhub<a class="headerlink" href="#start-jupyterhub" title="Permalink to this headline">¶</a></h2>
<p>Finally, start the server as our newly configured user, <code class="docutils literal notranslate"><span class="pre">rhea</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> /etc/jupyterhub
$ sudo -u rhea jupyterhub --JupyterHub.spawner_class<span class="o">=</span>sudospawner.SudoSpawner
</pre></div>
</div>
<p>And try logging in.</p>
</div>
<div class="section" id="troubleshooting-selinux">
<h2>Troubleshooting: SELinux<a class="headerlink" href="#troubleshooting-selinux" title="Permalink to this headline">¶</a></h2>
<p>If you still get a generic <code class="docutils literal notranslate"><span class="pre">Permission</span> <span class="pre">denied</span></code> <code class="docutils literal notranslate"><span class="pre">PermissionError</span></code>, it’s possible SELinux is blocking you.<br />Here’s how you can make a module to allow this.
First, put this in a file  named <code class="docutils literal notranslate"><span class="pre">sudo_exec_selinux.te</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>module sudo_exec_selinux <span class="m">1</span>.1<span class="p">;</span>

require <span class="o">{</span>
        <span class="nb">type</span> unconfined_t<span class="p">;</span>
        <span class="nb">type</span> sudo_exec_t<span class="p">;</span>
        class file <span class="o">{</span> <span class="nb">read</span> entrypoint <span class="o">}</span><span class="p">;</span>
<span class="o">}</span>

<span class="c1">#============= unconfined_t ==============</span>
allow unconfined_t sudo_exec_t:file entrypoint<span class="p">;</span>
</pre></div>
</div>
<p>Then run all of these commands as root:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ checkmodule -M -m -o sudo_exec_selinux.mod sudo_exec_selinux.te
$ semodule_package -o sudo_exec_selinux.pp -m sudo_exec_selinux.mod
$ semodule -i sudo_exec_selinux.pp
</pre></div>
</div>
</div>
<div class="section" id="troubleshooting-pam-session-errors">
<h2>Troubleshooting: PAM session errors<a class="headerlink" href="#troubleshooting-pam-session-errors" title="Permalink to this headline">¶</a></h2>
<p>If the PAM authentication doesn’t work and you see errors for
<code class="docutils literal notranslate"><span class="pre">login:session-auth</span></code>, or similar, considering updating to a more recent version
of jupyterhub and disabling the opening of PAM sessions with
<code class="docutils literal notranslate"><span class="pre">c.PAMAuthenticator.open_sessions=False</span></code>.</p>
</div>
</div>


              </div>
              
              
              <div class='prev-next-bottom'>
                
    <a class='left-prev' id="prev-link" href="config-proxy.html" title="previous page">Using a reverse proxy</a>
    <a class='right-next' id="next-link" href="config-reference.html" title="next page">Configuration Reference</a>

              </div>
              
          </main>
          

      </div>
    </div>

    <script src="../_static/js/index.js"></script>
    <footer class="footer mt-5 mt-md-0">
  <div class="container">
    <p>
          &copy; Copyright 2016, Project Jupyter team.<br/>
        Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.0.4.<br/>
    </p>
  </div>
</footer>
  </body>
</html>